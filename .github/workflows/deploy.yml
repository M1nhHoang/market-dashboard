# ============================================
# Deploy to VPS via SSH + Docker Compose
# ============================================
# Trigger: Push to master branch
#
# Required GitHub Secrets:
#   DEPLOY_PASSWORD  - SSH password for root@VPS
#   GH_PAT           - GitHub Personal Access Token (for private repo)
#
# Note: backend/.env is managed manually on VPS.
#       First deploy will copy from .env.example
# ============================================

name: Deploy to VPS

on:
  push:
    branches: [master]
  workflow_dispatch: # Allow manual trigger

env:
  DEPLOY_HOST: 160.191.86.48
  DEPLOY_USER: root
  DEPLOY_PATH: /root/minhhoang/market-dashboard

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.0
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        with:
          host: ${{ env.DEPLOY_HOST }}
          username: ${{ env.DEPLOY_USER }}
          password: ${{ secrets.DEPLOY_PASSWORD }}
          envs: GH_PAT
          script_stop: true
          command_timeout: 10m
          script: |
            set -e

            DEPLOY_PATH="${{ env.DEPLOY_PATH }}"
            REPO_URL="https://${GH_PAT}@github.com/M1nhHoang/market-dashboard.git"

            echo "=========================================="
            echo "üöÄ Deploying Market Intelligence Dashboard"
            echo "=========================================="

            # ------------------------------------------
            # 1. Clone or pull latest code
            # ------------------------------------------
            if [ ! -d "$DEPLOY_PATH/.git" ]; then
              echo "üì¶ First deploy - cloning repository..."
              mkdir -p "$(dirname $DEPLOY_PATH)"
              git clone "$REPO_URL" "$DEPLOY_PATH"
            else
              echo "üì• Pulling latest changes..."
              cd "$DEPLOY_PATH"
              git remote set-url origin "$REPO_URL"
              git fetch origin master
              git reset --hard origin/master
            fi

            cd "$DEPLOY_PATH"
            echo "üìç Current commit: $(git log --oneline -1)"

            # ------------------------------------------
            # 2. Create backend/.env from example if not exists
            # ------------------------------------------
            if [ ! -f backend/.env ]; then
              echo "üîë Creating backend/.env from .env.example..."
              cp backend/.env.example backend/.env
              echo "‚ö†Ô∏è  Please edit backend/.env on VPS with your API keys!"
            else
              echo "‚úÖ backend/.env already exists, skipping..."
            fi

            # ------------------------------------------
            # 3. Build and deploy with Docker Compose
            # ------------------------------------------
            echo "üê≥ Building and deploying containers..."
            docker compose down --remove-orphans || true
            docker compose up -d --build

            # ------------------------------------------
            # 4. Wait for health check
            # ------------------------------------------
            echo "‚è≥ Waiting for backend to be healthy..."
            RETRIES=20
            DELAY=5
            for i in $(seq 1 $RETRIES); do
              if docker inspect --format='{{.State.Health.Status}}' mi-backend 2>/dev/null | grep -q "healthy"; then
                echo "‚úÖ Backend is healthy!"
                break
              fi
              if [ $i -eq $RETRIES ]; then
                echo "‚ùå Backend health check failed after ${RETRIES} attempts"
                echo "--- Backend logs ---"
                docker compose logs --tail=50 backend
                exit 1
              fi
              echo "   Attempt $i/$RETRIES - waiting ${DELAY}s..."
              sleep $DELAY
            done

            # ------------------------------------------
            # 5. Verify all services
            # ------------------------------------------
            echo ""
            echo "=========================================="
            echo "üìä Service Status"
            echo "=========================================="
            docker compose ps
            echo ""
            echo "‚úÖ Deploy completed successfully!"
